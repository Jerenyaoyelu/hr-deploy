name: ç³»ç»Ÿä¼˜åŒ–

on:
  workflow_dispatch:
  # push:
  #   branches: [ main, master ]
    # paths:
    #   - 'emergency_optimize.sh'
    #   - 'docker-compose-limited.yml'
    #   - '.github/workflows/system-optimize.yml'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ‰§è¡Œç³»ç»Ÿä¼˜åŒ–
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        script: |
          echo "=== å¼€å§‹ç³»ç»Ÿä¼˜åŒ– ==="
          
          # 1. æ·»åŠ Swapç©ºé—´ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          if ! swapon --show | grep -q "/swapfile"; then
            echo "æ·»åŠ 2GB Swapç©ºé—´..."
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            echo "Swapç©ºé—´æ·»åŠ å®Œæˆ"
          else
            echo "Swapç©ºé—´å·²å­˜åœ¨"
          fi
          
          # 2. æ¸…ç†Dockerèµ„æº
          echo "æ¸…ç†Dockerèµ„æº..."
          docker system prune -f
          docker image prune -f
          
          # 3. é™åˆ¶Dockeræ—¥å¿—å¤§å°
          echo "é…ç½®Dockeræ—¥å¿—é™åˆ¶..."
          sudo tee /etc/docker/daemon.json > /dev/null << 'DOCKER_CONFIG'
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "2"
            },
            "storage-driver": "overlay2"
          }
          DOCKER_CONFIG
          
          # 4. é‡å¯Dockerå®ˆæŠ¤è¿›ç¨‹ï¼ˆä¸å½±å“è¿è¡Œä¸­çš„å®¹å™¨ï¼‰
          echo "é‡å¯Dockerå®ˆæŠ¤è¿›ç¨‹..."
          sudo systemctl restart docker
          
          # 5. æ¸…ç†ç³»ç»Ÿç¼“å­˜
          echo "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
          sudo sync
          sudo echo 3 > /proc/sys/vm/drop_caches
          
          # 6. ä¼˜åŒ–å†…å­˜ç®¡ç†å‚æ•°
          echo "ä¼˜åŒ–å†…å­˜ç®¡ç†å‚æ•°..."
          sudo tee -a /etc/sysctl.conf > /dev/null << 'SYSCTL_CONFIG'
          
          # å†…å­˜ä¼˜åŒ–
          vm.swappiness=10
          vm.vfs_cache_pressure=50
          vm.dirty_ratio=15
          vm.dirty_background_ratio=5
          
          # ç½‘ç»œä¼˜åŒ–
          net.core.rmem_max=16777216
          net.core.wmem_max=16777216
          SYSCTL_CONFIG
          
          sudo sysctl -p
          
          echo "=== ç³»ç»Ÿä¼˜åŒ–å®Œæˆ ==="
          
          # æ˜¾ç¤ºä¼˜åŒ–ç»“æžœ
          echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
          free -h
          echo ""
          echo "ç³»ç»Ÿè´Ÿè½½:"
          uptime
          echo ""
          echo "Dockerå®¹å™¨çŠ¶æ€:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "Swapç©ºé—´:"
          swapon --show
          echo ""
          echo "å¯ç”¨å†…å­˜ç™¾åˆ†æ¯”:"
          echo "å¯ç”¨å†…å­˜: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')"
        
    - name: ä¼˜åŒ–å®Œæˆé€šçŸ¥
      run: |
        echo "ðŸŽ‰ ç³»ç»Ÿä¼˜åŒ–å®Œæˆï¼"
        echo "æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
        echo ""
        echo "ä¼˜åŒ–å†…å®¹åŒ…æ‹¬:"
        echo "- æ·»åŠ 2GB Swapç©ºé—´"
        echo "- æ¸…ç†Dockerèµ„æº"
        echo "- é™åˆ¶Dockeræ—¥å¿—å¤§å°"
        echo "- ä¼˜åŒ–å†…å­˜ç®¡ç†å‚æ•°"
        echo "- æ¸…ç†ç³»ç»Ÿç¼“å­˜" 